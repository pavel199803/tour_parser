import json
import random
import time

import urllib.request
from datetime import datetime, timedelta

from aiogram import Router, Bot
from aiogram.filters import CommandStart
from aiogram.types import Message, URLInputFile, InlineKeyboardMarkup, InlineKeyboardButton

router = Router()

headers = [
    '–û–¢–ï–õ–¨, –ö–û–¢–û–†–´–ô –¢–û–ß–ù–û –ó–ê–ü–û–ú–ù–ò–¢–°–Ø –í–ê–úüî•',

    '–í–´ –ò–°–ö–ê–õ–ò –ò–ú–ï–ù–ù–û –≠–¢–û–¢üîùü§© –û–¢–ï–õ–¨',

    'üìç–ü–æ—Ä–∞ —Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ! –û—Ç–µ–ª—å –∏–∑ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø–æ–¥–±–æ—Ä–∫–∏ –æ—Ç –Ω–∞—à–∏—Ö —Ç—Ä–µ–≤–µ–ª-—ç–∫—Å–ø–µ—Ä—Ç–æ–≤:',

    '–ò—Å–∫–∞–ª–∏ –ø–æ–≤–æ–¥ –¥–ª—è –æ—Ç–ø—É—Å–∫–∞? –≠—Ç–æ –æ–Ω! –ü–æ—Ä–∞ –≤—ã–±–∏—Ä–∞—Ç—å –¥–∞—Ç—ã –≤—ã–ª–µ—Ç–∞üèùÔ∏è',

    '–í—ã–±–∏—Ä–∞–µ—Ç–µ, –∫–∞–∫–æ–π –∫—É—Ä–æ—Ä—Ç –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º? –õ–æ–≤–∏—Ç–µ –Ω–∞—à–µ –Ω–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µüåÖ',

    '–ü–æ—á–µ–º—É –≤—ã –µ—â–µ –Ω–µ –∫—É–ø–∏–ª–∏ —Ç—É—Ä –¢–£–î–ê?üó∫Ô∏èüòç',

    '–°–∫–æ—Ä–µ–µ —É—Å–ø–µ–≤–∞–π—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç—É—Äüëáüèº',

    '–¢–æ–ª—å–∫–æ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ —Ü–µ–Ω—ã –Ω–∞ —ç—Ç–æ—Ç —Ç—É—Ä!ü§©üî•',

    '–¢—ã –≤—Å–µ –µ—â–µ –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å?) –°–∫–æ—Ä–µ–µ –±—Ä–æ–Ω–∏—Ä—É–π –¥–∞—Ç—ã —Ç—É—Ä–∞üèùÔ∏è',

    '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ! –¢—É—Ç —à–æ–∫–∏—Ä—É—é—â–∏–µ —Ü–µ–Ω—ã –Ω–∞ —Ç—É—Ä—ãü§Øüëáüèº',

    '–≠—Ç–æ —á—Ç–æ –∑–∞ —Ü–µ–Ω—ãüòç ¬´–í–ê–£!¬ª, –≥–æ–≤–æ—Ä–∏–º –º—ãüëáüèº',                                                       

    'WOW! –≠—Ç–æ –∂–µ –Ω–æ–≤—ã–π —Ç—É—Ä –æ—Ç –ú–∞—Ä–∫–µ—Ç –°–ª–µ—Ç–∞—Ç—å –∂–¥–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–µ–±—èü§©',

    '–ü–æ–ª–µ—Ç–µ–ª–∏ –≤ –æ—Ç–ø—É—Å–∫?) –î–∞, –≤–æ—Ç —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æüëáüèºüèùÔ∏è',

    '–£—Å—Ç–∞–ª–∏ –æ—Ç —Ä–∞–±–æ—á–µ–π —Ä—É—Ç–∏–Ω—ã? –°–∫–æ—Ä–µ–µ –±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ —Ç—É—Äüî•',

    '–ì–¥–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑? –í—ã–±–∏—Ä–∞—Ç—å –≤–∞–º, –∞ –º—ã –ø–æ–º–æ–∂–µ–º —Å –∏–¥–µ—è–º–∏üëáüèºüòç',

    '–í–æ—Ç —ç—Ç–æ –¥–∞! –ù–æ–≤—ã–π —Ç—É—Ä –æ—Ç –ú–∞—Ä–∫–µ—Ç –°–ª–µ—Ç–∞—Ç—åü§©',

    '–í—ã —ç—Ç–æ –≤–∏–¥–µ–ª–∏?? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ç—É—Ä–æ–º —Å –¥—Ä—É–≥–æ–º, –≤–º–µ—Å—Ç–µ –æ—Ç–¥—ã—Ö–∞—Ç—å –≤–µ—Å–µ–ª–µ–µüó∫',

]




@router.message(CommandStart())
async def get_tours_day(massage: Message, bot: Bot):
    while True:
        destination = 'tours_of_the_day.json'   # —Å–∫–∞—á–∏–≤–∞–µ–º json —Ñ–∞–π–ª —Å —Ö–æ—Å—Ç–∏–Ω–≥–∞ 
        url = 'https://market-sletat.ru/tours_of_the_day.json'                  
        urllib.request.urlretrieve(url, destination)
        # url = 'https://market-sletat.ru/tours_of_the_day.json'
        # response = requests.get(url)

        with open('tours_of_the_day.json', encoding='utf-8') as file: # –≤—ã–∑–æ–≤ json —Å–ª–æ–≤–∞—Ä—è
            tours_dict = json.load(file)
            for key in tours_dict: # –ø–µ—Ä–µ–±–æ—Ä json —Å–ª–æ–≤–∞—Ä—è                                               
                newline_char = '\n'
                date_start = key['date_start']
                date_start = date_start.replace('-', '.')
                for n, i in enumerate(key['includes'], 0):# –ø–µ—Ä–µ–∏–º–µ–Ω–Ω–æ–≤—ã–≤–∞–µ–º includes
                    if i == "–ü–µ—Ä–µ–ª–µ—Ç":
                        key['includes'][n] = f"üõ©Ô∏è –ê–≤–∏–∞–ø–µ—Ä–µ–ª–µ—Ç"
                    elif i == "–ú–µ–¥ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞":
                        key['includes'][n] = f"üìò –ú–µ–¥.—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"
                    elif i == '–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ':
                        key['includes'][n] = f"üåê –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ –æ—Ç–µ–ª–µ (–Ω–æ–º–µ—Ä: {key['room_type']})"
                    elif i == '–ü–∏—Ç–∞–Ω–∏–µ':
                        key['includes'][n] = f"ü•£ –ü–∏—Ç–∞–Ω–∏–µ ({key['meals']})"
                    elif i == '–¢—Ä–∞–Ω—Å—Ñ–µ—Ä':
                        key['includes'][n] = f"üöô –¢—Ä–∞–Ω—Å—Ñ–µ—Ä"
                    elif i == '–û–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–µ':
                        key['includes'][n] = f"üè• –û–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–µ"                                                  
                    elif i == '–õ–µ—á–µ–Ω–∏–µ':
                        key['includes'][n] = f"üë®üèº‚Äç‚öïÔ∏è –õ–µ—á–µ–Ω–∏–µ)"
                    elif i == '–≠–∫—Å–∫—É—Ä—Å–∏—è':
                        key['includes'][n] = f"üè∞ –≠–∫—Å–∫—É—Ä—Å–∏—è"
                    elif i == '–¢–æ–ø–ª–∏–≤–Ω—ã–π —Å–±–æ—Ä':
                        key['includes'][n] = f"üí∏ –¢–æ–ø–ª–∏–≤–Ω—ã–π —Å–±–æ—Ä"
                    elif i == '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —É–∂–∏–Ω':
                        key['includes'][n] = f"üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —É–∂–∏–Ω"
                random_header = random.choice(headers) # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ 
                random_tour_photo = random.choice(key['tour_photo'])

                inline_tg = InlineKeyboardButton(   # –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
                    text="–ù–∞—à –ö–∞–Ω–∞–ª",
                    url='https://t.me/marketsletatspb'
                )
                inline_chat_bot = InlineKeyboardButton(
                    text="–¢—É—Ä–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç",
                    url='https://t.me/assistant_market_sletat_bot'
                )
                inline_buy = InlineKeyboardButton(
                    text="–ö—É–ø–∏—Ç—å –¢—É—Ä",
                    url=f"https://market-sletat.ru/tours-day/{key['id']}"
                )
                keyboard = InlineKeyboardMarkup(row_width=2,  # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω–ª–∞–π–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É 
                                                inline_keyboard=[
                                                    [inline_buy],
                                                    [inline_tg, inline_chat_bot]                                                       
                                                ])
                url = URLInputFile(f"https://market-sletat.ru{random_tour_photo}") # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ 
                await bot.send_photo(chat_id=-1002034874974,  # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–∂–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏ –≤—ã–∑—ã–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                                     photo=url,
                                     caption=f"<b>{random_header}</b>{newline_char}{newline_char}"  # 443453297  -1002034874974
                                             f"‚≠êÔ∏è<b>{key['hotel']} {key['stars']}*</b>{newline_char}"
                                             f"({key['country']}, {key['resort']}){newline_char}{newline_char}"
                                             f"üõ´ –í—ã–ª–µ—Ç –∏–∑ <b>{key['depart_city']} "
                                             f"{date_start[-2:]}.{date_start[-5:-3]}</b> ({key['nights']} –Ω–æ—á–µ–π){newline_char}"
                                             f"üí∑ <b>{key['price']} —Ä—É–±/—á–µ–ª</b> (–ø—Ä–∏ 2-—É—Ö–º–µ—Å—Ç–Ω–æ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏){newline_char}{newline_char}"
                                             f"<b>–í —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ –≤—Ö–æ–¥–∏—Ç:</b>{newline_char}"
                                             f"<i>{newline_char.join(key['includes'])}</i>{newline_char}{newline_char}"
                                             f"<b>üìû<a href='tel:+78126705911'>8-(812)-670-59-11</a></b>{newline_char}{newline_char}"
                                             f"<b>–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç—É—Ä–∞ –∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µüëáüèº</b>",
                                     parse_mode='HTML',
                                     reply_markup=keyboard
                                     )

                current = datetime.now()  # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–µ—Å—Ç–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
                late_time = current.replace(hour=22, minute=0, second=0, microsecond=0) # –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ 22:00
                if late_time <= current:
                    break
                else:
                    time.sleep(720) # –∑–∞–¥–µ—Ä–∂–∫–∞ 12 –º–∏–Ω

        future = current.replace(hour=14, minute=30, second=0, microsecond=0) # –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –≤ 14:30 –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è 
        if future <= current:
            future += timedelta(days=1) 

        print((future - current).seconds)
        time.sleep((future - current).seconds)
        
        # —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è 
            #tours = (
            #    f"<b>{random_header}</b>\n\n"
            #    f"‚≠êÔ∏è<b>{key['hotel']}</b>\n ({key['country']}, {key['resort']})\n\n"
            #    f"üõ´ –í—ã–ª–µ—Ç –∏–∑ <b>{key['depart_city']} {date_start[-2:]}.{date_start[-5:-3]}</b> ({key['nights']} –Ω–æ—á–µ–π)\n"
            #    f"üí∑ <b>{key['price']} —Ä—É–±/—á–µ–ª</b> (–ø—Ä–∏ 2-—É—Ö–º–µ—Å—Ç–Ω–æ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏)\n\n"
            #    f"<b>–í —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ –≤—Ö–æ–¥–∏—Ç:</b>\n"
            #    f"<i>{'\n'.join(key['includes'])}</i>\n\n"
            #    f"–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã <i>¬´–ú–∞—Ä–∫–µ—Ç –°–ª–µ—Ç–∞—Ç—å¬ª:</i>\n\n"
            #    f"1Ô∏è‚É£<i><a href='https://t.me/marketsletatspb'>"
            #    f"–ù–æ–≤–æ—Å—Ç–∏ —Ç—É—Ä–∏–∑–º–∞, –Ω–∞—à–∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–æ—Å—Ç—ã</a></i>üó∫Ô∏è\n"
            #    f"2Ô∏è‚É£<i><a href='https://t.me/assistant_market_sletat_bot'>–ï—Å–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–∞–º –Ω–µ –ø–æ–¥–æ—à–ª–æ, "
            #    f"–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –≤ –Ω–∞—à–µ–º –±–æ—Ç–µ –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º —Ç—É—Ä –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</a></i>‚úîÔ∏è\n\n"
            #    f"–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ —Ç—É—Ä —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n"
            #    f"üñ•Ô∏è <b><a href='https://market-sletat.ru/tours-day/{key['id']}'>"
            #    f"–ò–∑—É—á–∏—Ç—å —Ç—É—Ä –Ω–∞ —Å–∞–π—Ç–µ –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a></b>\n"
            #    f"üìû <b>8-(812)-670-59-11</b>",
            #)

            #await bot.send_message(chat_id=-1002034874974,
            #                       text=f"<b>–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã <i>¬´–ú–∞—Ä–∫–µ—Ç –°–ª–µ—Ç–∞—Ç—å¬ª:</i></b>\n\n"
            #                            f"1Ô∏è‚É£<i><a href='https://t.me/marketsletatspb'>"
            #                            f"–ù–æ–≤–æ—Å—Ç–∏ —Ç—É—Ä–∏–∑–º–∞, –Ω–∞—à–∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∏ "
            #                            f"–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–æ—Å—Ç—ã</a></i>üó∫Ô∏è\n"
            #                            f"2Ô∏è‚É£<i><a href='https://t.me/assistant_market_sletat_bot'>"
            #                            f"–ï—Å–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–∞–º –Ω–µ –ø–æ–¥–æ—à–ª–æ, "
            #                            f"–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –≤ –Ω–∞—à–µ–º –±–æ—Ç–µ –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º —Ç—É—Ä –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</a></i>‚úîÔ∏è\n\n",
            #                       parse_mode="HTML", disable_web_page_preview=True
            #                       )

